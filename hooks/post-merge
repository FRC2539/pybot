# Keep repository up-to-date with changes

function doUpdate
{
    if [[ "$1" != "envrc" ]]; then
        # Install any new git hooks
        root=`git rev-parse --show-toplevel`
        ln -sf $root/hooks/* $root/.git/hooks/

        # Install any new requirements
        pip install -r $PWD/requirements.txt > /dev/null

        # Re-enable direnv if there were .envrc changes
        if [[ `which direnv` ]]; then
            if [[ `direnv status | grep 'Found RC allowed false'` ]]; then
                direnv allow
                return
            fi
        fi
    fi

    # Update all modules
    pip list --outdated --format=freeze --disable-pip-version-check | grep -v '^\-e' > .pipup

    if [[ $? -eq 0 ]]; then
        cat .pipup | cut -d = -f 1  | xargs -n1 pip install -U --disable-pip-version-check > /dev/null
    fi

    rm -f .pipup
}

if [[ "$1" == "envrc" ]]; then
    # Called from .envrc to update pip packages
    doUpdate envrc
else
    if [[ "$1" != "force" ]]; then
        changedHook="$(git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD | grep "^hooks/post-merge$")"
        if [[ $changedHook ]]; then
            root=`git rev-parse --show-toplevel`
            bash $root/$changedHook force
            exit
        fi
    fi
    doUpdate &
fi
